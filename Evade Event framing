local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- ลบ GUI เก่า
pcall(function()
	local g = PlayerGui:FindFirstChild("FluentGui")
	if g then g:Destroy() end
end)
pcall(function()
	local g = PlayerGui:FindFirstChild("FluentFloatingUI")
	if g then g:Destroy() end
end)

-- ตัวละครและ HRP
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")

player.CharacterAdded:Connect(function(c)
	character = c
	hrp = c:WaitForChild("HumanoidRootPart")
end)

-- โหลด Fluent UI
local Fluent = loadstring(game:HttpGet(
	"https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"
))()

local Window = Fluent:CreateWindow({
	Title = "KUYREX HUB " .. Fluent.Version,
	SubTitle = "Evade x Kuyrex",
	TabWidth = 160,
	Size = UDim2.fromOffset(500, 300),
	Acrylic = true,
	Theme = "Dark",
	MinimizeKey = Enum.KeyCode.LeftControl
})

local Tabs = {
	Main = Window:AddTab({ Title = "หน้าหลัก", Icon = "house" })
}
Window:SelectTab(1)

-- Toggle states
local AutoFarmTP = false
local AutoStartGame = false
local AutoDodgeNextbot = false
local Busy = false
local InWait = false

-- ===== จุดรอสูงๆ =====
local WAIT_PART = Instance.new("Part")
WAIT_PART.Size = Vector3.new(20, 2, 20)
WAIT_PART.Anchored = true
WAIT_PART.CanCollide = true
WAIT_PART.Transparency = 1
WAIT_PART.CFrame = CFrame.new(0, 1000, 0) -- สูงมาก นอกสายตาผู้เล่น
WAIT_PART.Parent = workspace

-- ฟังก์ชันวาป
local function Teleport(cf)
	if character and hrp then
		character:PivotTo(cf)
		hrp.AssemblyLinearVelocity = Vector3.zero
		hrp.AssemblyAngularVelocity = Vector3.zero
	end
end

-- หาเหรียญ
local function GetTickets()
	local folder = workspace:FindFirstChild("Game")
		and workspace.Game:FindFirstChild("Effects")
		and workspace.Game.Effects:FindFirstChild("Tickets")
	if not folder then return {} end
	local list = {}
	for _,v in ipairs(folder:GetChildren()) do
		if v:IsA("BasePart") then
			table.insert(list, v)
		elseif v:IsA("Model") and v.PrimaryPart then
			table.insert(list, v.PrimaryPart)
		end
	end
	return list
end

-- หา NextBot ใกล้สุด
local function GetNearestNextbot()
	local folder = workspace:FindFirstChild("Game") and workspace.Game:FindFirstChild("Players")
	if not folder then return nil, math.huge end
	local nearest, dist = nil, math.huge
	for _,v in ipairs(folder:GetChildren()) do
		local s = v:FindFirstChild("Idle")
		if s and s:IsA("Sound") and s.Parent and s.Parent:IsA("BasePart") then
			local d = (s.Parent.Position - hrp.Position).Magnitude
			if d < dist then
				dist = d
				nearest = s.Parent
			end
		end
	end
	return nearest, dist
end

-- ฟาร์มเหรียญ
task.spawn(function()
	while true do
		if AutoFarmTP and character and not Busy then
			local items = GetTickets()
			if #items > 0 then
				Busy = true
				InWait = false
				for _,item in ipairs(items) do
					if not AutoFarmTP then break end
					if item and item.Parent then
						Teleport(item.CFrame)
						local t = tick()
						while item.Parent and AutoFarmTP and tick() - t < 1.5 do
							task.wait(0.05)
						end
					end
				end
				Busy = false
			else
				if not InWait then
					InWait = true
					Teleport(WAIT_PART.CFrame + Vector3.new(0, 3, 0))
				end
			end
		end
		task.wait(0.15)
	end
end)

-- Auto Start Game
local ChangeModeEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("Player"):WaitForChild("ChangePlayerMode")
task.spawn(function()
	while true do
		if AutoStartGame then
			local gp = workspace:FindFirstChild("Game")
			local pf = gp and gp:FindFirstChild("Players")
			if pf and not pf:FindFirstChild(player.Name) then
				pcall(function()
					ChangeModeEvent:FireServer(true)
				end)
			end
		end
		task.wait(2)
	end
end)

-- หลบ NextBot
RunService.Heartbeat:Connect(function()
	if not AutoDodgeNextbot or not hrp then return end
	local bot, dist = GetNearestNextbot()
	if bot and dist < 32 then
		local dir = (hrp.Position - bot.Position).Unit
		local safePos = WAIT_PART.Position + Vector3.new(
			math.random(-10,10),
			0,
			math.random(-10,10)
		)
		hrp.CFrame = CFrame.new(safePos)
	end
end)

-- ===== Toggles =====
Tabs.Main:AddToggle("AutoTicketsTP", {
	Title = "ฟาร์มเหรียญอีเว้นท์ ✅",
	Default = false
}):OnChanged(function(v)
	AutoFarmTP = v
	if not v then
		Busy = false
		InWait = false
	end
end)

Tabs.Main:AddToggle("AutoDodgeNextbot", {
	Title = "หลบNextBotอัติโนมัติ ✅",
	Default = false
}):OnChanged(function(v)
	AutoDodgeNextbot = v
end)

Tabs.Main:AddToggle("AutoStartGame", {
	Title = "เริ่มเกมอัตโนมัติ ✅",
	Default = false
}):OnChanged(function(v)
	AutoStartGame = v
end)

-- Floating Button
local gui = Instance.new("ScreenGui", PlayerGui)
gui.Name = "FluentFloatingUI"
gui.ResetOnSpawn = false

local button = Instance.new("TextButton", gui)
button.Size = UDim2.new(0, 52, 0, 52)
button.Position = UDim2.new(0, 15, 0.5, 0)
button.AnchorPoint = Vector2.new(0, 0.5)
button.Text = "กดเปิด"
button.Font = Enum.Font.GothamBold
button.TextScaled = true
button.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
button.TextColor3 = Color3.fromRGB(255, 255, 255)
button.BorderSizePixel = 0
Instance.new("UICorner", button).CornerRadius = UDim.new(0, 12)

button.MouseButton1Click:Connect(function()
	Window:Minimize()
end)

local dragging, dragStart, startPos = false

button.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = i.Position
		startPos = button.Position
		i.Changed:Connect(function()
			if i.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

UserInputService.InputChanged:Connect(function(i)
	if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
		local d = i.Position - dragStart
		button.Position = UDim2.new(
			startPos.X.Scale,
			startPos.X.Offset + d.X,
			startPos.Y.Scale,
			startPos.Y.Offset + d.Y
		)
	end
end)

Fluent:Notify({
	Title = "พร้อมแล้ว",
	Content = "ฟาร์มเหรียญ + หลบ NextBot + จุดรอสูง",
	Duration = 3
})
